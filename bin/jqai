#!/bin/bash
set -e

usage() {
    echo "Usage: jqai <description> [file]"
    echo "       cat file.json | jqai <description>"
    echo ""
    echo "Like jq, but for dummies."
    echo "Uses Claude to generate the jq selector from your description."
    echo ""
    echo "Examples:"
    echo "  jqai 'get all user names' data.json"
    echo "  cat data.json | jqai 'extract ids where status is active'"
    exit 1
}

if [ -z "$1" ] || [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    usage
fi

description="$1"
shift

if [ -n "$1" ]; then
    json_input=$(cat "$1")
else
    json_input=$(cat)
fi

json_sample=$(echo "$json_input" | head -c 4096)

prompt="Generate jq selector for: $description

JSON:
$json_sample

Output ONLY the jq expression, nothing else."

echo "Generating jq selector..." >&2
selector=$(claude -p "$prompt" --model haiku --max-tokens 100 --temperature 0 2>/dev/null | sed 's/^```jq//; s/^```//; s/```$//; /^$/d' | tr -d '\n')
echo "Running: jq '$selector'" >&2

echo "$json_input" | jq "$selector"
