#!/bin/bash
set -e

usage() {
    echo "Usage: jqai <description> [file]"
    echo "       cat file.json | jqai <description>"
    echo ""
    echo "Like jq, but takes a plain text description instead of a query selector."
    echo "Uses Claude to generate the jq selector from your description."
    echo ""
    echo "Examples:"
    echo "  jqai 'get all user names' data.json"
    echo "  cat data.json | jqai 'extract ids where status is active'"
    exit 1
}

if [ -z "$1" ] || [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    usage
fi

description="$1"
shift

if [ -n "$1" ]; then
    json_input=$(cat "$1")
else
    json_input=$(cat)
fi

json_sample=$(echo "$json_input" | head -c 4096)

prompt="You are a jq expert. Given this JSON sample and the user's request, output ONLY the jq selector/filter that accomplishes their goal. Output nothing else - no explanation, no markdown, just the raw jq expression.

JSON sample:
$json_sample

User wants: $description"

echo "Generating jq selector..." >&2
selector=$(claude -p "$prompt" --model haiku 2>/dev/null | sed 's/^```jq//; s/^```//; s/```$//; /^$/d' | tr -d '\n')
echo "Running: jq '$selector'" >&2

echo "$json_input" | jq "$selector"
