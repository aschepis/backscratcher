#!/bin/bash
# List git worktrees with their safety status for deletion

if ! git rev-parse --git-dir &>/dev/null; then
    echo "Not in a git repository"
    exit 1
fi

main_branch=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@')
if [ -z "$main_branch" ]; then
    main_branch="main"
fi

# Check if gh is available for PR status
has_gh=$(command -v gh &>/dev/null && gh auth status &>/dev/null && echo "yes" || echo "no")

printf "%-50s %-20s %s\n" "WORKTREE" "BRANCH" "STATUS"
printf "%s\n" "$(printf '=%.0s' {1..90})"

while IFS= read -r line; do
    if [[ "$line" =~ ^worktree\ (.+)$ ]]; then
        worktree_path="${BASH_REMATCH[1]}"
    elif [[ "$line" =~ ^branch\ refs/heads/(.+)$ ]]; then
        branch="${BASH_REMATCH[1]}"
    elif [[ "$line" == "" && -n "$worktree_path" ]]; then
        status=""
        issues=()

        if [ -d "$worktree_path" ]; then
            # Check for uncommitted changes
            if [ -n "$(git -C "$worktree_path" status --porcelain 2>/dev/null)" ]; then
                issues+=("uncommitted changes")
            fi

            # Check for unpushed commits (if branch exists)
            if [ -n "$branch" ]; then
                unpushed=$(git -C "$worktree_path" log --oneline "origin/$branch..$branch" 2>/dev/null | wc -l | tr -d ' ')
                if [ "$unpushed" -gt 0 ]; then
                    issues+=("$unpushed unpushed commit(s)")
                fi

                # Check if branch is merged into main
                if git merge-base --is-ancestor "$branch" "origin/$main_branch" 2>/dev/null; then
                    merged="yes"
                else
                    merged="no"
                    # Only flag as issue if not main worktree
                    if [ "$branch" != "$main_branch" ]; then
                        issues+=("not merged to $main_branch")
                    fi
                fi
            fi
        else
            issues+=("path missing")
        fi

        if [ ${#issues[@]} -eq 0 ]; then
            status="✓ safe to delete"
        else
            status="⚠ ${issues[*]}"
        fi

        # Mark main worktree
        if git -C "$worktree_path" rev-parse --is-inside-work-tree &>/dev/null; then
            is_main=$(git -C "$worktree_path" rev-parse --git-dir 2>/dev/null)
            if [[ "$is_main" == ".git" ]]; then
                status="(main worktree)"
            fi
        fi

        printf "%-50s %-20s %s\n" "$worktree_path" "${branch:-(detached)}" "$status"
        worktree_path=""
        branch=""
    fi
done < <(git worktree list --porcelain; echo "")
