#!/bin/bash
# Create a git worktree from a branch name

set -e

if ! git rev-parse --git-dir &>/dev/null; then
    echo "Not in a git repository"
    exit 1
fi

usage() {
    echo "Usage: mkwt <branch-name> [worktree-path]"
    echo ""
    echo "Examples:"
    echo "  mkwt feature-auth        # Create worktree for existing branch"
    echo "  mkwt -b new-feature      # Create worktree with new branch"
    exit 1
}

if [ -z "$1" ]; then
    usage
fi

# Parse arguments
new_branch=false
if [ "$1" == "-b" ]; then
    new_branch=true
    shift
fi

target="$1"
custom_path="$2"

# Find the repo root (main worktree location)
repo_root=$(git worktree list --porcelain | grep "^worktree" | head -1 | cut -d' ' -f2)
repo_name=$(basename "$repo_root")

# Default worktree location: sibling directory to main repo
worktrees_base=$(dirname "$repo_root")

branch="$target"
worktree_name="${repo_name}-${branch}"

if [ "$new_branch" = true ]; then
    # New branch - will be created with worktree
    :
else
    # Existing branch - fetch it first
    git fetch origin "$branch" 2>/dev/null || true
fi

# Determine worktree path
if [ -n "$custom_path" ]; then
    worktree_path="$custom_path"
else
    worktree_path="${worktrees_base}/${worktree_name}"
fi

# Check if worktree already exists
if [ -d "$worktree_path" ]; then
    echo "Worktree already exists at: $worktree_path"
    read -p "Switch to it? (y/n): " switch
    if [[ "$switch" == "y" || "$switch" == "yes" ]]; then
        cd "$worktree_path" && exec $SHELL
    fi
    exit 0
fi

# Create the worktree
echo ""
if [ "$new_branch" = true ]; then
    echo "Creating worktree with new branch '$branch'..."
    git worktree add -b "$branch" "$worktree_path"
else
    echo "Creating worktree for branch '$branch'..."
    if git show-ref --verify --quiet "refs/heads/$branch"; then
        git worktree add "$worktree_path" "$branch"
    elif git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
        git worktree add "$worktree_path" "$branch"
    else
        echo "Branch '$branch' not found locally or on origin."
        read -p "Create new branch? (y/n): " create
        if [[ "$create" == "y" || "$create" == "yes" ]]; then
            git worktree add -b "$branch" "$worktree_path"
        else
            exit 1
        fi
    fi
fi

echo ""
echo "âœ“ Worktree created at: $worktree_path"
echo ""
read -p "Switch to it? (y/n): " switch
if [[ "$switch" == "y" || "$switch" == "yes" ]]; then
    cd "$worktree_path" && exec $SHELL
fi
